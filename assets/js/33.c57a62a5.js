(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{507:function(s,t,a){"use strict";a.r(t);var n=a(42),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("传统的 Web 服务器，每个客户端连接作为一个单独的进程或线程处理，需在切换任务时将 CPU 切换到新的任务并创建一个新的运行时上下文，消耗额外的内存和 CPU 时间，当并发请求增加时，服务器响应变慢，从而对性能产生负面影响。")]),s._v(" "),a("p",[s._v("Nginx 是开源、高性能、高可靠的 Web 和反向代理服务器，而且支持热部署，几乎可以做到 7 * 24 小时不间断运行，即使运行几个月也不需要重新启动，还能在不间断服务的情况下对软件版本进行热更新。性能是 Nginx 最重要的考量，其占用内存少、并发能力强、能支持高达 5w 个并发连接数，最重要的是，Nginx 是免费的并可以商业化，配置使用也比较简单。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/nginx.png",alt:"Nginx"}})]),s._v(" "),a("p",[s._v("Nginx 的最重要的几个使用场景：")]),s._v(" "),a("ol",[a("li",[s._v("静态资源服务，通过本地文件系统提供服务；")]),s._v(" "),a("li",[s._v("反向代理服务，延伸出包括缓存、负载均衡等；")]),s._v(" "),a("li",[s._v("API 服务，OpenResty ；")])]),s._v(" "),a("p",[s._v("对于前端来说 Node.js 不陌生了，Nginx 和 Node.js 的很多理念类似，HTTP 服务器、事件驱动、异步非阻塞等，且 Nginx 的大部分功能使用 Node.js 也可以实现，但 Nginx 和 Node.js 并不冲突，都有自己擅长的领域。Nginx 擅长于底层服务器端资源的处理（静态资源处理转发、反向代理，负载均衡等），Node.js 更擅长上层具体业务逻辑的处理，两者可以完美组合，共同助力前端开发。")]),s._v(" "),a("p",[s._v("下面我们着重学习一下 Nginx 的使用。")]),s._v(" "),a("h2",{attrs:{id:"_0-基础概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-基础概念"}},[s._v("#")]),s._v(" 0. 基础概念")]),s._v(" "),a("h3",{attrs:{id:"_0-1-简单请求和非简单请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-1-简单请求和非简单请求"}},[s._v("#")]),s._v(" 0.1 简单请求和非简单请求")]),s._v(" "),a("p",[s._v("首先我们来了解一下简单请求和非简单请求，如果同时满足下面两个条件，就属于简单请求：")]),s._v(" "),a("ol",[a("li",[s._v("请求方法是 "),a("code",[s._v("HEAD")]),s._v("、"),a("code",[s._v("GET")]),s._v("、"),a("code",[s._v("POST")]),s._v(" 三种之一；")]),s._v(" "),a("li",[s._v("HTTP 头信息不超过右边着几个字段："),a("code",[s._v("Accept")]),s._v("、"),a("code",[s._v("Accept-Language")]),s._v("、"),a("code",[s._v("Content-Language")]),s._v("、"),a("code",[s._v("Last-Event-ID``Content-Type")]),s._v(" 只限于三个值 "),a("code",[s._v("application/x-www-form-urlencoded")]),s._v("、"),a("code",[s._v("multipart/form-data")]),s._v("、"),a("code",[s._v("text/plain")]),s._v("；")])]),s._v(" "),a("p",[s._v("凡是不同时满足这两个条件的，都属于非简单请求。")]),s._v(" "),a("p",[s._v("浏览器处理简单请求和非简单请求的方式不一样：")]),s._v(" "),a("p",[a("strong",[s._v("简单请求")])]),s._v(" "),a("p",[s._v("对于简单请求，浏览器会在头信息中增加 "),a("code",[s._v("Origin")]),s._v(" 字段后直接发出，"),a("code",[s._v("Origin")]),s._v(" 字段用来说明，本次请求来自的哪个源（协议+域名+端口）。")]),s._v(" "),a("p",[s._v("如果服务器发现 "),a("code",[s._v("Origin")]),s._v(" 指定的源不在许可范围内，服务器会返回一个正常的 HTTP 回应，浏览器取到回应之后发现回应的头信息中没有包含 "),a("code",[s._v("Access-Control-Allow-Origin")]),s._v(" 字段，就抛出一个错误给 XHR 的 "),a("code",[s._v("error")]),s._v(" 事件；")]),s._v(" "),a("p",[s._v("如果服务器发现 "),a("code",[s._v("Origin")]),s._v(" 指定的域名在许可范围内，服务器返回的响应会多出几个 "),a("code",[s._v("Access-Control-")]),s._v(" 开头的头信息字段。")]),s._v(" "),a("p",[a("strong",[s._v("非简单请求")])]),s._v(" "),a("p",[s._v("非简单请求是那种对服务器有特殊要求的请求，比如请求方法是 "),a("code",[s._v("PUT")]),s._v(" 或 "),a("code",[s._v("DELETE")]),s._v("，或 "),a("code",[s._v("Content-Type")]),s._v(" 值为 "),a("code",[s._v("application/json")]),s._v("。浏览器会在正式通信之前，发送一次 HTTP 预检 "),a("code",[s._v("OPTIONS")]),s._v(" 请求，先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些 HTTP 请求方法和头信息字段。只有得到肯定答复，浏览器才会发出正式的 "),a("code",[s._v("XHR")]),s._v(" 请求，否则报错。")]),s._v(" "),a("h3",{attrs:{id:"_0-2-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-2-跨域"}},[s._v("#")]),s._v(" 0.2 跨域")]),s._v(" "),a("p",[s._v("在浏览器上当前访问的网站向另一个网站发送请求获取数据的过程就是"),a("strong",[s._v("跨域请求")]),s._v("。")]),s._v(" "),a("p",[s._v("跨域是浏览器的同源策略决定的，是一个重要的浏览器安全策略，用于限制一个 origin 的文档或者它加载的脚本与另一个源的资源进行交互，它能够帮助阻隔恶意文档，减少可能被攻击的媒介，可以使用 CORS 配置解除这个限制。")]),s._v(" "),a("p",[s._v("关于跨域网上已经有很多解释，这里就不啰嗦，也可以直接看 MDN 的 <浏览器的同源策略> 文档进一步了解，这里就列举几个同源和不同元的例子，相信程序员都能看得懂。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同源的例子")]),s._v("\nhttp://example.com/app1/index.html  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只是路径不同")]),s._v("\nhttp://example.com/app2/index.html\n\nhttp://Example.com:80  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只是大小写差异")]),s._v("\nhttp://example.com\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不同源的例子")]),s._v("\nhttp://example.com/app1   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 协议不同")]),s._v("\nhttps://example.com/app2\n\nhttp://example.com        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# host 不同")]),s._v("\nhttp://www.example.com\nhttp://myapp.example.com\n\nhttp://example.com        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口不同")]),s._v("\nhttp://example.com:8080\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h2",{attrs:{id:"_1-nginx基础功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-nginx基础功能"}},[s._v("#")]),s._v(" 1. Nginx基础功能")]),s._v(" "),a("h3",{attrs:{id:"_1-1-正向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-正向代理"}},[s._v("#")]),s._v(" 1.1 正向代理")]),s._v(" "),a("p",[s._v("局域网中的电脑用户想要直接访问网络是不可行的，只能通过代理服务器来访问，这种代理服务就被称为正向代理。")]),s._v(" "),a("p",[s._v("正向代理类似一个跳板机，代理访问外部资源")]),s._v(" "),a("p",[s._v("比如我们国内访问谷歌，直接访问访问不到，我们可以通过一个正向代理服务器，请求发到代理服，代理服务器能够访问谷歌，这样由代理去谷歌取到返回数据，再返回给我们，这样我们就能访问谷歌了")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gallery.sleepyocean.cn/resource/img/4cc3006be559ef3e9264d4367b5f019b",alt:"正向代理示意图"}})]),s._v(" "),a("p",[a("strong",[s._v("正向代理的用途")])]),s._v(" "),a("ol",[a("li",[s._v("访问原来无法访问的资源，如google")]),s._v(" "),a("li",[s._v("可以做缓存，加速访问资源")]),s._v(" "),a("li",[s._v("对客户端访问授权，上网进行认证")]),s._v(" "),a("li",[s._v("代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息")])]),s._v(" "),a("h3",{attrs:{id:"_1-2-反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-反向代理"}},[s._v("#")]),s._v(" 1.2 反向代理")]),s._v(" "),a("p",[s._v("反向代理（Reverse Proxy）实际运行方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。")]),s._v(" "),a("p",[s._v("客户端无法感知代理，因为客户端访问网络不需要配置，只要把请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据，然后再返回到客户端。")]),s._v(" "),a("p",[s._v("此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器 IP 地址。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gallery.sleepyocean.cn/resource/img/5e11c9224c95ae73f8e9192883283479",alt:"反向代理示意图"}})]),s._v(" "),a("p",[a("strong",[s._v("反向代理的作用")])]),s._v(" "),a("ol",[a("li",[s._v("保证内网的安全，阻止web攻击，大型网站，通常将反向代理作为公网访问地址，Web服务器是内网")]),s._v(" "),a("li",[s._v("负载均衡，通过反向代理服务器来优化网站的负载")])]),s._v(" "),a("h3",{attrs:{id:"_1-3-负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-负载均衡"}},[s._v("#")]),s._v(" 1.3 负载均衡")]),s._v(" "),a("p",[s._v("负载均衡（Load Balance），意思是将负载（工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行。是解决高性能，单点故障（高可用），扩展性（水平伸缩）的终极解决方案。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gallery.sleepyocean.cn/resource/img/8342d3ce297089352aea96181b481e59",alt:"负载均衡随机算法示例"}})]),s._v(" "),a("p",[s._v("假设有 15 个请求发送到代理服务器，那么由代理服务器根据服务器数量，随机分配，如上图，server1分配5个请求、server2分配3个请求、server3分配7个请求，这个过程就叫做负载均衡。")]),s._v(" "),a("h3",{attrs:{id:"_1-4-动静分离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-动静分离"}},[s._v("#")]),s._v(" 1.4 动静分离")]),s._v(" "),a("p",[s._v("为了加快网站的解析速度，可以把动态页面和静态页面交给不同的服务器来解析，加快解析的速度，降低由单个服务器的压力。")]),s._v(" "),a("p",[s._v("一般来说，都需要将动态资源和静态资源分开，由于 Nginx 的高并发和静态资源缓存等特性，经常将静态资源部署在 Nginx 上。如果请求的是静态资源，直接到静态资源目录获取资源，如果是动态资源的请求，则利用反向代理的原理，把请求转发给对应后台应用去处理，从而实现动静分离。")]),s._v(" "),a("p",[s._v("使用前后端分离后，可以很大程度提升静态资源的访问速度，即使动态服务不可用，静态资源的访问也不会受到影响。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/640.png",alt:"Image"}})]),s._v(" "),a("h2",{attrs:{id:"_2-nginx常用命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-nginx常用命令"}},[s._v("#")]),s._v(" 2. Nginx常用命令")]),s._v(" "),a("p",[s._v("Nginx 的命令在控制台中输入 "),a("code",[s._v("nginx -h")]),s._v(" 就可以看到完整的命令，这里列举几个常用的命令：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("nginx -s reload  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 向主进程发送信号，重新加载配置文件，热重启")]),s._v("\nnginx -s reopen\t "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启 Nginx")]),s._v("\nnginx -s stop    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 快速关闭")]),s._v("\nnginx -s quit    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 等待工作进程处理完成后关闭")]),s._v("\nnginx -T         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看当前 Nginx 最终的配置")]),s._v("\nnginx -t -c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("配置路径"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查配置是否有问题，如果已经在配置目录，则不需要-c")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("code",[s._v("systemctl")]),s._v(" 是 Linux 系统应用管理工具 "),a("code",[s._v("systemd")]),s._v(" 的主命令，用于管理系统，我们也可以用它来对 Nginx 进行管理，相关命令如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl start nginx    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 Nginx")]),s._v("\nsystemctl stop nginx     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止 Nginx")]),s._v("\nsystemctl restart nginx  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启 Nginx")]),s._v("\nsystemctl reload nginx   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新加载 Nginx，用于修改配置后")]),s._v("\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" nginx   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置开机启动 Nginx")]),s._v("\nsystemctl disable nginx  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭开机启动 Nginx")]),s._v("\nsystemctl status nginx   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 Nginx 运行状态")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"_3-nginx配置语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-nginx配置语法"}},[s._v("#")]),s._v(" 3. Nginx配置语法")]),s._v(" "),a("p",[s._v("Nginx 的主配置文件是 "),a("code",[s._v("/etc/nginx/nginx.conf")]),s._v("，你可以使用 "),a("code",[s._v("cat -n nginx.conf")]),s._v(" 来查看配置。")]),s._v(" "),a("p",[a("code",[s._v("nginx.conf")]),s._v(" 结构图可以这样概括：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("main        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全局配置，对全局生效")]),s._v("\n├── events  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置影响 Nginx 服务器或与用户的网络连接")]),s._v("\n├── http    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置")]),s._v("\n│   ├── upstream "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置后端服务器具体地址，负载均衡配置不可或缺的部分")]),s._v("\n│   ├── server   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置虚拟主机的相关参数，一个 http 块中可以有多个 server 块")]),s._v("\n│   ├── server\n│   │   ├── location  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# server 块可以包含多个 location 块，location 指令用于匹配 uri")]),s._v("\n│   │   ├── location\n│   │   └── "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n│   └── "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n└── "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("一个 Nginx 配置文件的结构就像 "),a("code",[s._v("nginx.conf")]),s._v(" 显示的那样，配置文件的语法规则：")]),s._v(" "),a("ol",[a("li",[s._v("配置文件由指令与指令块构成；")]),s._v(" "),a("li",[s._v("每条指令以 "),a("code",[s._v(";")]),s._v(" 分号结尾，指令与参数间以空格符号分隔；")]),s._v(" "),a("li",[s._v("指令块以 "),a("code",[s._v("{}")]),s._v(" 大括号将多条指令组织在一起；")]),s._v(" "),a("li",[a("code",[s._v("include")]),s._v(" 语句允许组合多个配置文件以提升可维护性；")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("#")]),s._v(" 符号添加注释，提高可读性；")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("$")]),s._v(" 符号使用变量；")]),s._v(" "),a("li",[s._v("部分指令的参数支持正则表达式；")])]),s._v(" "),a("h3",{attrs:{id:"_3-1-典型配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-典型配置"}},[s._v("#")]),s._v(" 3.1 典型配置")]),s._v(" "),a("p",[s._v("Nginx 的典型配置：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("user  nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行用户，默认即是nginx，可以不进行设置")]),s._v("\nworker_processes  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx 进程数，一般设置为和 CPU 核数一样")]),s._v("\nerror_log  /var/log/nginx/error.log warn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx 的错误日志存放目录")]),s._v("\npid        /var/run/nginx.pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx 服务启动时的 pid 存放位置")]),s._v("\n\nevents "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    use epoll"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用epoll的I/O模型(如果你不知道Nginx该使用哪种轮询方法，会自动选择一个最适合你操作系统的)")]),s._v("\n    worker_connections "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个进程允许最大并发数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nhttp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置使用最频繁的部分，代理、缓存、日志定义等绝大多数功能和第三方模块的配置都在这里设置")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置日志模式")]),s._v("\n    log_format  main  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$remote_addr - $remote_user [$time_local] \"$request\" '")]),s._v("\n                      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$status $body_bytes_sent \"$http_referer\" '")]),s._v("\n                      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'"$http_user_agent" "$http_x_forwarded_for"\'')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    access_log  /var/log/nginx/access.log  main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx访问日志存放位置")]),s._v("\n\n    sendfile            on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启高效传输模式")]),s._v("\n    tcp_nopush          on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 减少网络报文段的数量")]),s._v("\n    tcp_nodelay         on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    keepalive_timeout   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保持连接的时间，也叫超时时间，单位秒")]),s._v("\n    types_hash_max_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    include             /etc/nginx/mime.types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件扩展名与类型映射表")]),s._v("\n    default_type        application/octet-stream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认文件类型")]),s._v("\n\n    include /etc/nginx/conf.d/*.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载子配置项")]),s._v("\n    \n    server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \tlisten       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置监听的端口")]),s._v("\n    \tserver_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置的域名")]),s._v("\n    \t\n    \tlocation / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \t\troot   /usr/share/nginx/html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 网站根目录")]),s._v("\n    \t\tindex  index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认首页文件")]),s._v("\n    \t\tdeny "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.168")]),s._v(".22.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止访问的ip地址，可以为all")]),s._v("\n    \t\tallow "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.168")]),s._v(".33.44；"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许访问的ip地址，可以为all")]),s._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \t\n    \terror_page "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("504")]),s._v(" /50x.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认50x对应的访问页面")]),s._v("\n    \terror_page "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" error.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同上")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br")])]),a("p",[s._v("server 块可以包含多个 location 块，location 指令用于匹配 uri，语法：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("location "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ~ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ~* "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ^~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" uri "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("指令后面：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("=")]),s._v(" 精确匹配路径，用于不含正则表达式的 uri 前，如果匹配成功，不再进行后续的查找；")]),s._v(" "),a("li",[a("code",[s._v("^~")]),s._v(" 用于不含正则表达式的 uri 前，表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找；")]),s._v(" "),a("li",[a("code",[s._v("~")]),s._v(" 表示用该符号后面的正则去匹配路径，区分大小写；")]),s._v(" "),a("li",[a("code",[s._v("~*")]),s._v(" 表示用该符号后面的正则去匹配路径，不区分大小写。跟 "),a("code",[s._v("~")]),s._v(" 优先级都比较低，如有多个location的正则能匹配的话，则使用正则表达式最长的那个；")])]),s._v(" "),a("p",[s._v("如果 uri 包含正则表达式，则必须要有 "),a("code",[s._v("~")]),s._v(" 或 "),a("code",[s._v("~*")]),s._v(" 标志。")]),s._v(" "),a("h3",{attrs:{id:"_3-2-全局变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-全局变量"}},[s._v("#")]),s._v(" 3.2 全局变量")]),s._v(" "),a("p",[s._v("Nginx 有一些常用的全局变量，你可以在配置的任何位置使用它们，如下表：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[s._v("全局变量名")]),s._v(" "),a("th",{staticStyle:{"text-align":"left"}},[s._v("功能")])])]),s._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$host")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("请求信息中的 "),a("code",[s._v("Host")]),s._v("，如果请求中没有 "),a("code",[s._v("Host")]),s._v(" 行，则等于设置的服务器名，不包含端口")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$request_method")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("客户端请求类型，如 "),a("code",[s._v("GET")]),s._v("、"),a("code",[s._v("POST")])])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$args")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("请求中的参数")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$arg_PARAMETER")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("GET")]),s._v(" 请求中变量名 PARAMETER 参数的值，例如："),a("code",[s._v("$http_user_agent")]),s._v("(Uaer-Agent 值), "),a("code",[s._v("$http_referer")]),s._v("...")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$content_length")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("请求头中的 "),a("code",[s._v("Content-length")]),s._v(" 字段")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$http_cookie")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("客户端cookie信息")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$remote_addr")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("客户端的IP地址")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$remote_port")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("客户端的端口")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$http_user_agent")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("客户端agent信息")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$server_protocol")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("请求使用的协议，如 "),a("code",[s._v("HTTP/1.0")]),s._v("、"),a("code",[s._v("HTTP/1.1")])])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$server_addr")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("服务器地址")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$server_name")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("服务器名称")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$server_port")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("服务器的端口号")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[s._v("$scheme")])]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("HTTP 方法（如http，https）")])])])]),s._v(" "),a("p",[s._v("还有更多的内置预定义变量，可以直接搜索关键字「nginx内置预定义变量」可以看到一堆博客写这个，这些变量都可以在配置文件中直接使用。")]),s._v(" "),a("h2",{attrs:{id:"_4-设置二级域名"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-设置二级域名"}},[s._v("#")]),s._v(" 4. 设置二级域名")]),s._v(" "),a("p",[s._v("在某某云 ☁️ 上购买了域名之后，就可以配置虚拟主机了，一般配置的路径在 "),a("code",[s._v("域名管理 -> 解析 -> 添加记录")]),s._v(" 中添加二级域名，配置后某某云会把二级域名也解析到我们配置的服务器 IP 上，然后我们在 Nginx 上配置一下虚拟主机的访问监听，就可以拿到从这个二级域名过来的请求了。")]),s._v(" "),a("p",[s._v("现在我自己的服务器上配置了一个 fe 的二级域名，也就是说在外网访问 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 的时候，也可以访问到我们的服务器了。")]),s._v(" "),a("p",[s._v("由于默认配置文件 "),a("code",[s._v("/etc/nginx/nginx.conf")]),s._v(" 的 http 模块中有一句 "),a("code",[s._v("include /etc/nginx/conf.d/*.conf")]),s._v(" 也就是说 "),a("code",[s._v("conf.d")]),s._v(" 文件夹下的所有 "),a("code",[s._v("*.conf")]),s._v(" 文件都会作为子配置项被引入配置文件中。为了维护方便，我在 "),a("code",[s._v("/etc/nginx/conf.d")]),s._v(" 文件夹中新建一个 "),a("code",[s._v("fe.sherlocked93.club.conf")]),s._v(" ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/nginx/conf.d/fe.sherlocked93.club.conf")]),s._v("\n\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tserver_name fe.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\tlocation / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\troot  /usr/share/nginx/html/fe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\tindex index.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("然后在 "),a("code",[s._v("/usr/share/nginx/html")]),s._v(" 文件夹下新建 fe 文件夹，新建文件 "),a("code",[s._v("index.html")]),s._v("，内容随便写点，改完 "),a("code",[s._v("nginx -s reload")]),s._v(" 重新加载，浏览器中输入 "),a("code",[s._v("fe.sherlocked93.club")]),s._v("，发现从二级域名就可以访问到我们刚刚新建的 fe 文件夹。")]),s._v(" "),a("h2",{attrs:{id:"_5-配置反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-配置反向代理"}},[s._v("#")]),s._v(" 5. 配置反向代理")]),s._v(" "),a("p",[s._v("反向代理是工作中最常用的服务器功能，经常被用来解决跨域问题，下面简单介绍一下如何实现反向代理。")]),s._v(" "),a("p",[s._v("首先进入 Nginx 的主配置文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v(" /etc/nginx/nginx.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后我们去 "),a("code",[s._v("http")]),s._v(" 模块的 "),a("code",[s._v("server")]),s._v(" 块中的 "),a("code",[s._v("location /")]),s._v("，增加一行将默认网址重定向到最大学习网站 Bilibili 的 "),a("code",[s._v("proxy_pass")]),s._v(" 配置 🤓 ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tlisten "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tserver_name *.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\n\tlocation / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tproxy_pass http://www.bilibili.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("改完保存退出，"),a("code",[s._v("nginx -s reload")]),s._v(" 重新加载，进入默认网址，那么现在就直接跳转到 B 站了，实现了一个简单的代理。")]),s._v(" "),a("p",[s._v("实际使用中，可以将请求转发到本机另一个服务器上，也可以根据访问的路径跳转到不同端口的服务中。")]),s._v(" "),a("p",[s._v("比如我们监听 "),a("code",[s._v("9001")]),s._v(" 端口，然后把访问不同路径的请求进行反向代理：")]),s._v(" "),a("ol",[a("li",[s._v("把访问 "),a("code",[s._v("http://127.0.0.1:9001/edu")]),s._v(" 的请求转发到 "),a("code",[s._v("http://127.0.0.1:8080")])]),s._v(" "),a("li",[s._v("把访问 "),a("code",[s._v("http://127.0.0.1:9001/vod")]),s._v(" 的请求转发到 "),a("code",[s._v("http://127.0.0.1:8081")])])]),s._v(" "),a("p",[s._v("这种要怎么配置呢，首先同样打开主配置文件，然后在 http 模块下增加一个 server 块：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name *.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  location ~ /edu/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass http://127.0.0.1:8080"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n  location ~ /vod/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass http://127.0.0.1:8081"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("反向代理还有一些其他的指令，可以了解一下：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("proxy_set_header")]),s._v("：在将客户端请求发送给后端服务器之前，更改来自客户端的请求头信息；")]),s._v(" "),a("li",[a("code",[s._v("proxy_connect_timeout")]),s._v("：配置 Nginx 与后端代理服务器尝试建立连接的超时时间；")]),s._v(" "),a("li",[a("code",[s._v("proxy_read_timeout")]),s._v("：配置 Nginx 向后端服务器组发出 read 请求后，等待相应的超时时间；")]),s._v(" "),a("li",[a("code",[s._v("proxy_send_timeout")]),s._v("：配置 Nginx 向后端服务器组发出 write 请求后，等待相应的超时时间；")]),s._v(" "),a("li",[a("code",[s._v("proxy_redirect")]),s._v("：用于修改后端服务器返回的响应头中的 Location 和 Refresh。")])]),s._v(" "),a("h2",{attrs:{id:"_6-跨域cors配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-跨域cors配置"}},[s._v("#")]),s._v(" 6.跨域CORS配置")]),s._v(" "),a("p",[s._v("现在前后端分离的项目一统天下，经常本地起了前端服务，需要访问不同的后端地址，不可避免遇到跨域问题。")]),s._v(" "),a("p",[s._v("要解决跨域问题，我们来制造一个跨域问题。首先和前面设置二级域名的方式一样，先设置好 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 和 "),a("code",[s._v("be.sherlocked93.club")]),s._v(" 二级域名，都指向本云服务器地址，虽然对应 IP 是一样的，但是在 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 域名发出的请求访问 "),a("code",[s._v("be.sherlocked93.club")]),s._v(" 域名的请求还是跨域了，因为访问的 host 不一致。")]),s._v(" "),a("h3",{attrs:{id:"_6-1-使用反向代理解决跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-使用反向代理解决跨域"}},[s._v("#")]),s._v(" 6.1 使用反向代理解决跨域")]),s._v(" "),a("p",[s._v("在前端服务地址为 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 的页面请求 "),a("code",[s._v("be.sherlocked93.club")]),s._v(" 的后端服务导致的跨域，可以这样配置：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name fe.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass be.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("这样就将对前一个域名 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 的请求全都代理到了 "),a("code",[s._v("be.sherlocked93.club")]),s._v("，前端的请求都被我们用服务器代理到了后端地址下，绕过了跨域。")]),s._v(" "),a("p",[s._v("这里对静态文件的请求和后端服务的请求都以 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 开始，不易区分，所以为了实现对后端服务请求的统一转发，通常我们会约定对后端服务的请求加上 "),a("code",[s._v("/apis/")]),s._v(" 前缀或者其他的 path 来和对静态资源的请求加以区分，此时我们可以这样配置：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求跨域，约定代理后端服务请求path以/apis/开头")]),s._v("\nlocation ^~/apis/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里重写了请求，将正则匹配中的第一个分组的path拼接到真正的请求后面，并用break停止后续匹配")]),s._v("\n    rewrite ^/apis/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ /"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_pass be.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 两个域名之间cookie的传递与回写")]),s._v("\n    proxy_cookie_domain be.sherlocked93.club fe.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("这样，静态资源我们使用 "),a("code",[s._v("fe.sherlocked93.club/xx.html")]),s._v("，动态资源我们使用 "),a("code",[s._v("fe.sherlocked93.club/apis/getAwo")]),s._v("，浏览器页面看起来仍然访问的前端服务器，绕过了浏览器的同源策略，毕竟我们看起来并没有跨域。")]),s._v(" "),a("p",[s._v("也可以统一一点，直接把前后端服务器地址直接都转发到另一个 "),a("code",[s._v("server.sherlocked93.club")]),s._v("，只通过在后面添加的 path 来区分请求的是静态资源还是后端服务，看需求了。")]),s._v(" "),a("h3",{attrs:{id:"_6-2-配置header解决跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-配置header解决跨域"}},[s._v("#")]),s._v(" 6.2 配置Header解决跨域")]),s._v(" "),a("p",[s._v("当浏览器在访问跨源的服务器时，也可以在跨域的服务器上直接设置 Nginx，从而前端就可以无感地开发，不用把实际上访问后端的地址改成前端服务的地址，这样可适性更高。")]),s._v(" "),a("p",[s._v("比如前端站点是 "),a("code",[s._v("fe.sherlocked93.club")]),s._v("，这个地址下的前端页面请求 "),a("code",[s._v("be.sherlocked93.club")]),s._v(" 下的资源，比如前者的 "),a("code",[s._v("fe.sherlocked93.club/index.html")]),s._v(" 内容是这样的：")]),s._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("h1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("welcome fe.sherlocked93.club!!"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("h1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("'")]),s._v("text/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" xmlhttp "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("XMLHttpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    xmlhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"GET"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://be.sherlocked93.club/index.html"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    xmlhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("很明显这里是跨域请求，在浏览器中直接访问 "),a("code",[s._v("http://be.sherlocked93.club/index.html")]),s._v(" 是可以访问到的，但是在 "),a("code",[s._v("fe.sherlocked93.club")]),s._v(" 的 html 页面访问就会出现跨域。")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("/etc/nginx/conf.d/")]),s._v(" 文件夹中新建一个配置文件，对应二级域名 "),a("code",[s._v("be.sherlocked93.club")]),s._v(" ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/nginx/conf.d/be.sherlocked93.club.conf")]),s._v("\n\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name  be.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n\tadd_header "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Origin'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_origin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全局变量获得当前请求origin，带cookie的请求不支持*")]),s._v("\n\tadd_header "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Credentials'")]),s._v("'true"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("';    # 为 true 可带上 cookie\n\tadd_header '")]),s._v("Access-Control-Allow-Methods"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("GET, POST, OPTIONS"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("';  # 允许请求方法\n\tadd_header '")]),s._v("Access-Control-Allow-Headers"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$http_access_control_request_headers;  # 允许请求的 header，可以为 *\n\tadd_header '")]),s._v("Access-Control-Expose-Headers"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("Content-Length,Content-Range"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\n\t\n  if ($request_method = '")]),s._v("OPTIONS"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("') {\n\t\tadd_header '")]),s._v("Access-Control-Max-Age"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("' 1728000;   # OPTIONS 请求的有效期，在有效期内不用发出另一条预检请求\n\t\tadd_header '")]),s._v("Content-Type"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("text/plain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("charset")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf-8"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\n\t\tadd_header '")]),s._v("Content-Length' "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n\t\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("204")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 200 也可以")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n\tlocation / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\troot  /usr/share/nginx/html/be"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\tindex index.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("然后 "),a("code",[s._v("nginx -s reload")]),s._v(" 重新加载配置。这时再访问 "),a("code",[s._v("fe.sherlocked93.club/index.html")]),s._v(" 结果如下，请求中出现了我们刚刚配置的 Header：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/640-20210119154337468.png",alt:"配置Header解决跨域"}})]),s._v(" "),a("p",[s._v("跨域解决")]),s._v(" "),a("h2",{attrs:{id:"_7-开启gzip压缩"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-开启gzip压缩"}},[s._v("#")]),s._v(" 7. 开启gzip压缩")]),s._v(" "),a("p",[s._v("gzip 是一种常用的网页压缩技术，传输的网页经过 gzip 压缩之后大小通常可以变为原来的一半甚至更小（官网原话），更小的网页体积也就意味着带宽的节约和传输速度的提升，特别是对于访问量巨大大型网站来说，每一个静态资源体积的减小，都会带来可观的流量与带宽的节省。")]),s._v(" "),a("p",[s._v("百度可以找到很多检测站点来查看目标网页有没有开启 gzip 压缩，在下随便找了一个 <网页GZIP压缩检测> 输入掘金 "),a("code",[s._v("juejin.im")]),s._v(" 来偷窥下掘金有没有开启 gzip。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/640-20210119154742117.png",alt:"Image"}})]),s._v(" "),a("p",[s._v("这里可以看到掘金是开启了 gzip 的，压缩效果还挺不错，达到了 52% 之多，本来 "),a("code",[s._v("34kb")]),s._v(" 的网页体积，压缩完只需要 "),a("code",[s._v("16kb")]),s._v("，可以想象网页传输速度提升了不少。")]),s._v(" "),a("h3",{attrs:{id:"_7-1-nginx配置gzip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-nginx配置gzip"}},[s._v("#")]),s._v(" 7.1 Nginx配置gzip")]),s._v(" "),a("p",[s._v("使用 gzip 不仅需要 Nginx 配置，浏览器端也需要配合，需要在请求消息头中包含 "),a("code",[s._v("Accept-Encoding: gzip")]),s._v("（IE5 之后所有的浏览器都支持了，是现代浏览器的默认设置）。一般在请求 html 和 css 等静态资源的时候，支持的浏览器在 request 请求静态资源的时候，会加上 "),a("code",[s._v("Accept-Encoding: gzip")]),s._v(" 这个 header，表示自己支持 gzip 的压缩方式，Nginx 在拿到这个请求的时候，如果有相应配置，就会返回经过 gzip 压缩过的文件给浏览器，并在 response 相应的时候加上 "),a("code",[s._v("content-encoding: gzip")]),s._v(" 来告诉浏览器自己采用的压缩方式（因为浏览器在传给服务器的时候一般还告诉服务器自己支持好几种压缩方式），浏览器拿到压缩的文件后，根据自己的解压方式进行解析。")]),s._v(" "),a("p",[s._v("先来看看 Nginx 怎么进行 gzip 配置，和之前的配置一样，为了方便管理，还是在 "),a("code",[s._v("/etc/nginx/conf.d/")]),s._v(" 文件夹中新建配置文件 "),a("code",[s._v("gzip.conf")]),s._v(" ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/nginx/conf.d/gzip.conf")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认off，是否开启gzip")]),s._v("\ngzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上面两个开启基本就能跑起了，下面的愿意折腾就了解一下")]),s._v("\ngzip_static on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ngzip_proxied any"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ngzip_vary on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ngzip_comp_level "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ngzip_buffers "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" 8k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gzip_min_length 1k;")]),s._v("\ngzip_http_version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("稍微解释一下：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("gzip_types")]),s._v("：要采用 gzip 压缩的 MIME 文件类型，其中 text/html 被系统强制启用；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_static")]),s._v("：默认 off，该模块启用后，Nginx 首先检查是否存在请求静态文件的 gz 结尾的文件，如果有则直接返回该 "),a("code",[s._v(".gz")]),s._v(" 文件内容；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_proxied")]),s._v("：默认 off，nginx做为反向代理时启用，用于设置启用或禁用从代理服务器上收到相应内容 gzip 压缩；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_vary")]),s._v("：用于在响应消息头中添加 "),a("code",[s._v("Vary：Accept-Encoding")]),s._v("，使代理服务器根据请求头中的 "),a("code",[s._v("Accept-Encoding")]),s._v(" 识别是否启用 gzip 压缩；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_comp_level")]),s._v("：gzip 压缩比，压缩级别是 1-9，1 压缩级别最低，9 最高，级别越高压缩率越大，压缩时间越长，建议 4-6；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_buffers")]),s._v("：获取多少内存用于缓存压缩结果，16 8k 表示以 8k*16 为单位获得；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_min_length")]),s._v("：允许压缩的页面最小字节数，页面字节数从header头中的 "),a("code",[s._v("Content-Length")]),s._v(" 中进行获取。默认值是 0，不管页面多大都压缩。建议设置成大于 1k 的字节数，小于 1k 可能会越压越大；")]),s._v(" "),a("li",[a("strong",[s._v("gzip_http_version")]),s._v("：默认 1.1，启用 gzip 所需的 HTTP 最低版本；")])]),s._v(" "),a("p",[s._v("这个配置可以插入到 http 模块整个服务器的配置里，也可以插入到需要使用的虚拟主机的 "),a("code",[s._v("server")]),s._v(" 或者下面的 "),a("code",[s._v("location")]),s._v(" 模块中，当然像上面我们这样写的话就是被 include 到 http 模块中了。")]),s._v(" "),a("p",[s._v("其他更全的配置信息可以查看 <官网文档ngx_http_gzip_module>，配置前是这样的：\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/image-20210119155419528.png",alt:"image-20210119155419528"}})]),s._v(" "),a("p",[s._v("配置之后 response 的 header 里面多了一个 "),a("code",[s._v("Content-Encoding: gzip")]),s._v("，返回信息被压缩了：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/image-20210119155822082.png",alt:"image-20210119155822082"}})]),s._v(" "),a("p",[s._v("注意了，一般 gzip 的配置建议加上 "),a("code",[s._v("gzip_min_length 1k")]),s._v("，不加的话：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/image-20210119160030861.png",alt:"image-20210119160030861"}})]),s._v(" "),a("p",[s._v("由于文件太小，gzip 压缩之后得到了 -48% 的体积优化，压缩之后体积还比压缩之前体积大了，所以最好设置低于 "),a("code",[s._v("1kb")]),s._v(" 的文件就不要 gzip 压缩了 🤪")]),s._v(" "),a("h3",{attrs:{id:"_7-2-webpack的gzip配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-webpack的gzip配置"}},[s._v("#")]),s._v(" 7.2 Webpack的gzip配置")]),s._v(" "),a("p",[s._v("当前端项目使用 Webpack 进行打包的时候，也可以开启 gzip 压缩：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// vue-cli3 的 vue.config.js 文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" CompressionWebpackPlugin "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'compression-webpack-plugin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// gzip 配置")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("configureWebpack")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("config")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NODE_ENV")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'production'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 生产环境")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("plugins")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CompressionWebpackPlugin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("test")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token regex"}},[a("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("\\.js$|\\.html$|\\.css")]),a("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 匹配文件名")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("threshold")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10240")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 文件压缩阈值，对超过10k的进行压缩")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("deleteOriginalAssets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 是否删除源文件")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("由此打包出来的文件如下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/640-20210119160151355.png",alt:"Image"}})]),s._v(" "),a("p",[s._v("这里可以看到某些打包之后的文件下面有一个对应的 "),a("code",[s._v(".gz")]),s._v(" 经过 "),a("code",[s._v("gzip")]),s._v(" 压缩之后的文件，这是因为这个文件超过了 "),a("code",[s._v("10kb")]),s._v("，有的文件没有超过 "),a("code",[s._v("10kb")]),s._v(" 就没有进行 "),a("code",[s._v("gzip")]),s._v(" 打包，如果你期望压缩文件的体积阈值小一点，可以在 "),a("code",[s._v("compression-webpack-plugin")]),s._v(" 这个插件的配置里进行对应配置。")]),s._v(" "),a("p",[s._v("那么为啥这里 Nginx 已经有了 gzip 压缩，Webpack 这里又整了个 gzip 呢，因为如果全都是使用 Nginx 来压缩文件，会耗费服务器的计算资源，如果服务器的 "),a("code",[s._v("gzip_comp_level")]),s._v(" 配置的比较高，就更增加服务器的开销，相应增加客户端的请求时间，得不偿失。")]),s._v(" "),a("p",[s._v("如果压缩的动作在前端打包的时候就做了，把打包之后的高压缩等级文件作为静态资源放在服务器上，Nginx 会优先查找这些压缩之后的文件返回给客户端，相当于把压缩文件的动作从 Nginx 提前给 Webpack 打包的时候完成，节约了服务器资源，所以一般推介在生产环境应用 Webpack 配置 gzip 压缩。")]),s._v(" "),a("h2",{attrs:{id:"_8-配置负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-配置负载均衡"}},[s._v("#")]),s._v(" 8. 配置负载均衡")]),s._v(" "),a("p",[s._v("负载均衡在之前已经介绍了相关概念了，主要思想就是把负载均匀合理地分发到多个服务器上，实现压力分流的目的。")]),s._v(" "),a("p",[s._v("主要配置如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("http "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  upstream myserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip_hash;  # ip_hash 方式")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fair;   # fair 方式")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8081"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载均衡目的服务地址")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8080"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8082 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# weight 方式，不写默认为 1")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n  server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \tproxy_pass http://myserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      proxy_connect_timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("Nginx 提供了好几种分配方式，默认为"),a("strong",[s._v("轮询")]),s._v("，就是轮流来。有以下几种分配方式：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("轮询")]),s._v("，默认方式，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务挂了，能自动剔除；")]),s._v(" "),a("li",[a("strong",[s._v("weight")]),s._v("，权重分配，指定轮询几率，权重越高，在被访问的概率越大，用于后端服务器性能不均的情况；")]),s._v(" "),a("li",[a("strong",[s._v("ip_hash")]),s._v("，每个请求按访问 IP 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决动态网页 session 共享问题。负载均衡每次请求都会重新定位到服务器集群中的某一个，那么已经登录某一个服务器的用户再重新定位到另一个服务器，其登录信息将会丢失，这样显然是不妥的；")]),s._v(" "),a("li",[a("strong",[s._v("fair")]),s._v("（第三方），按后端服务器的响应时间分配，响应时间短的优先分配，依赖第三方插件 nginx-upstream-fair，需要先安装；")])]),s._v(" "),a("h2",{attrs:{id:"_9-配置动静分离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-配置动静分离"}},[s._v("#")]),s._v(" 9. 配置动静分离")]),s._v(" "),a("p",[s._v("动静分离在之前也介绍过了，就是把动态和静态的请求分开。方式主要有两种，一种 是纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案。另外一种方法就是动态跟静态文件混合在一起发布， 通过 Nginx 配置来分开。")]),s._v(" "),a("p",[s._v("通过 location 指定不同的后缀名实现不同的请求转发。通过 expires 参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量。具体 expires 定义：是给一个资源设定一个过期时间，也就是说无需去服务端验证，直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源。（如果经常更新的文件，不建议使用 expires 来缓存），我这里设置 3d，表示在这 3 天之内访问这个URL，发送一个请求，比对服务器该文件最后更新时间没有变化。则不会从服务器抓取，返回状态码 304，如果有修改，则直接从服务器重新下载，返回状态码 200。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  location /www/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  \troot /data/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    index index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n  location /image/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  \troot /data/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    autoindex on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h2",{attrs:{id:"_10-配置高可用集群-双机热备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-配置高可用集群-双机热备"}},[s._v("#")]),s._v(" 10. 配置高可用集群（双机热备）")]),s._v(" "),a("p",[s._v("当主 Nginx 服务器宕机之后，切换到备份 Nginx 服务器")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/640-20210119160550432.png",alt:"Image"}})]),s._v(" "),a("p",[s._v("首先安装 keepalived，")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" keepalived -y\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后编辑 "),a("code",[s._v("/etc/keepalived/keepalived.conf")]),s._v(" 配置文件，并在配置文件中增加 "),a("code",[s._v("vrrp_script")]),s._v(" 定义一个外围检测机制，并在 "),a("code",[s._v("vrrp_instance")]),s._v(" 中通过定义 "),a("code",[s._v("track_script")]),s._v(" 来追踪脚本执行过程，实现节点转移：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("global_defs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   notification_email "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        acassen@firewall"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loc\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n   notification_email_from Alexandre@firewall"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loc\n   smtp_server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v("\n   smtp_connect_timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 上面都是邮件配置，没卵用")]),s._v("\n   router_id "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LVS_DEVEL")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前服务器名字，用hostname命令来查看")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_script chk_maintainace "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 检测机制的脚本名称为chk_maintainace")]),s._v("\n    script "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[[ -e/etc/keepalived/down ]] && exit 1 || exit 0"')]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 可以是脚本路径或脚本命令")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// script "/etc/keepalived/nginx_check.sh"    // 比如这样的脚本路径')]),s._v("\n    interval "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 每隔2秒检测一次")]),s._v("\n    weight "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当脚本执行成立，那么把当前服务器优先级改为-20")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nvrrp_instanceVI_1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 每一个vrrp_instance就是定义一个虚拟路由器")]),s._v("\n    state "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("MASTER")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 主机为MASTER，备用机为BACKUP")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("eth0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 网卡名字，可以从ifconfig中查找")]),s._v("\n    virtual_router_id "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 虚拟路由的id号，一般小于255，主备机id需要一样")]),s._v("\n    priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 优先级，master的优先级比backup的大")]),s._v("\n    advert_int "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 默认心跳间隔")]),s._v("\n    authentication "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 认证机制")]),s._v("\n        auth_type "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PASS")]),s._v("\n        auth_pass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 密码")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 虚拟地址vip")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".8")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("其中检测脚本 "),a("code",[s._v("nginx_check.sh")]),s._v("，这里提供一个：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("A")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx --no-header "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$A")]),s._v(" -eq "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    /usr/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 尝试重新启动nginx")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 睡眠2秒")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx --no-header "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" -eq "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("killall")]),s._v(" keepalived "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动失败，将keepalived服务杀死。将vip漂移到其它备份节点")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("复制一份到备份服务器，备份 Nginx 的配置要将 "),a("code",[s._v("state")]),s._v(" 后改为 "),a("code",[s._v("BACKUP")]),s._v("，"),a("code",[s._v("priority")]),s._v(" 改为比主机小。")]),s._v(" "),a("p",[s._v("设置完毕后各自 "),a("code",[s._v("service keepalived start")]),s._v(" 启动，经过访问成功之后，可以把 Master 机的 keepalived 停掉，此时 Master 机就不再是主机了 "),a("code",[s._v("service keepalived stop")]),s._v("，看访问虚拟 IP 时是否能够自动切换到备机 "),a("code",[s._v("ip addr")]),s._v("。")]),s._v(" "),a("p",[s._v("再次启动 Master 的 keepalived，此时 vip 又变到了主机上。")]),s._v(" "),a("h2",{attrs:{id:"_11-适配pc或移动设备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_11-适配pc或移动设备"}},[s._v("#")]),s._v(" 11. 适配PC或移动设备")]),s._v(" "),a("p",[s._v("根据用户设备不同返回不同样式的站点，以前经常使用的是纯前端的自适应布局，但无论是复杂性和易用性上面还是不如分开编写的好，比如我们常见的淘宝、京东......这些大型网站就都没有采用自适应，而是用分开制作的方式，根据用户请求的 "),a("code",[s._v("user-agent")]),s._v(" 来判断是返回 PC 还是 H5 站点。")]),s._v(" "),a("p",[s._v("首先在 "),a("code",[s._v("/usr/share/nginx/html")]),s._v(" 文件夹下 "),a("code",[s._v("mkdir")]),s._v(" 分别新建两个文件夹 "),a("code",[s._v("PC")]),s._v(" 和 "),a("code",[s._v("mobile")]),s._v("，"),a("code",[s._v("vim")]),s._v(" 编辑两个 "),a("code",[s._v("index.html")]),s._v(" 随便写点内容。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/share/nginx/html\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" pc mobile\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" pc\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" index.html   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 随便写点比如 hello pc!")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/mobile\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" index.html   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 随便写点比如 hello mobile!")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("然后和设置二级域名虚拟主机时候一样，去 "),a("code",[s._v("/etc/nginx/conf.d")]),s._v(" 文件夹下新建一个配置文件 "),a("code",[s._v("fe.sherlocked93.club.conf")]),s._v(" ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/nginx/conf.d/fe.sherlocked93.club.conf")]),s._v("\n\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tserver_name fe.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\tlocation / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\troot  /usr/share/nginx/html/pc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_user_agent")]),s._v(" ~* "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'(Android|webOS|iPhone|iPod|BlackBerry)'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      root /usr/share/nginx/html/mobile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\tindex index.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("配置基本没什么不一样的，主要多了一个 "),a("code",[s._v("if")]),s._v(" 语句，然后使用 "),a("code",[s._v("$http_user_agent")]),s._v(" 全局变量来判断用户请求的 "),a("code",[s._v("user-agent")]),s._v("，指向不同的 root 路径，返回对应站点。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/SleepyOcean/ImageRepo@master/uPic/640.gif",alt:"Image"}})]),s._v(" "),a("p",[s._v("可以看到在模拟使用移动端访问的时候，Nginx 返回的站点变成了移动端对应的 html 了。")]),s._v(" "),a("h2",{attrs:{id:"_12-配置https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_12-配置https"}},[s._v("#")]),s._v(" 12. 配置HTTPS")]),s._v(" "),a("p",[s._v("具体配置过程网上挺多的了，也可以使用你购买的某某云，一般都会有免费申请的服务器证书，安装直接看所在云的操作指南即可。")]),s._v(" "),a("p",[s._v("我购买的腾讯云提供的亚洲诚信机构颁发的免费证书只能一个域名使用，二级域名什么的需要另外申请，但是申请审批比较快，一般几分钟就能成功，然后下载证书的压缩文件，里面有个 nginx 文件夹，把 "),a("code",[s._v("xxx.crt")]),s._v(" 和 "),a("code",[s._v("xxx.key")]),s._v(" 文件拷贝到服务器目录，再配置下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" ssl http2 default_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL 访问端口号为 443")]),s._v("\n  server_name sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 填写绑定证书的域名")]),s._v("\n\n  ssl_certificate /etc/nginx/https/1_sherlocked93.club_bundle.crt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 证书文件地址")]),s._v("\n  ssl_certificate_key /etc/nginx/https/2_sherlocked93.club.key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 私钥文件地址")]),s._v("\n  ssl_session_timeout 10m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#请按照以下协议配置")]),s._v("\n  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("aNULL:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("MD5:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("RC4:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DHE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_prefer_server_ciphers on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root         /usr/share/nginx/html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    index        index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("写完 "),a("code",[s._v("nginx -t -q")]),s._v(" 校验一下，没问题就 "),a("code",[s._v("nginx -s reload")]),s._v("，现在去访问 "),a("code",[s._v("https://sherlocked93.club/")]),s._v(" 就能访问 HTTPS 版的网站了。")]),s._v(" "),a("p",[s._v("一般还可以加上几个增强安全性的命令：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("add_header X-Frame-Options DENY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 减少点击劫持")]),s._v("\nadd_header X-Content-Type-Options nosniff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止服务器自动解析资源类型")]),s._v("\nadd_header X-Xss-Protection "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 防XSS攻击")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"_13-一些常用技巧"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-一些常用技巧"}},[s._v("#")]),s._v(" 13. 一些常用技巧")]),s._v(" "),a("h3",{attrs:{id:"_13-1-静态服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-1-静态服务"}},[s._v("#")]),s._v(" 13.1 静态服务")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name  static.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  charset utf-8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 防止中文文件名乱码")]),s._v("\n\n  location /download "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v("\t          /usr/share/nginx/html/static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 静态资源目录")]),s._v("\n    \n    autoindex               on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启静态资源列目录")]),s._v("\n    autoindex_exact_size    off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# on(默认)显示文件的确切大小，单位是byte；off显示文件大概大小，单位KB、MB、GB")]),s._v("\n    autoindex_localtime     off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# off(默认)时显示的文件时间为GMT时间；on显示的文件时间为服务器时间")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_13-2-图片防盗链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-2-图片防盗链"}},[s._v("#")]),s._v(" 13.2 图片防盗链")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name  *.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 图片防盗链")]),s._v("\n  location ~* "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gif"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("jpg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("jpeg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("png"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("bmp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("swf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    valid_referers none blocked "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只允许本机 IP 外链引用")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$invalid_referer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("403")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h3",{attrs:{id:"_13-3-请求过滤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-3-请求过滤"}},[s._v("#")]),s._v(" 13.3 请求过滤")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 非指定请求全返回 403")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_method")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("~ ^"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GET"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("POST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("HEAD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("403")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# IP访问限制（只允许IP是 192.168.0.2 机器访问）")]),s._v("\n  allow "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  deny all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n  root   html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  index  index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_13-4-配置图片、字体等静态文件缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-4-配置图片、字体等静态文件缓存"}},[s._v("#")]),s._v(" 13.4 配置图片、字体等静态文件缓存")]),s._v(" "),a("p",[s._v("由于图片、字体、音频、视频等静态文件在打包的时候通常会增加了 hash，所以缓存可以设置的长一点，先设置强制缓存，再设置协商缓存；如果存在没有 hash 值的静态文件，建议不设置强制缓存，仅通过协商缓存判断是否需要使用缓存。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 图片缓存时间设置")]),s._v("\nlocation ~ .*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("css"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("js"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("jpg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("png"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("gif"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("swf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("woff"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("woff2"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("eot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("svg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("ttf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("otf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("mp3"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("m4a"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("aac"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("txt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\texpires 10d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果不希望缓存")]),s._v("\nexpires -1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"_13-5-单页面项目-history-路由配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-5-单页面项目-history-路由配置"}},[s._v("#")]),s._v(" 13.5 单页面项目 history 路由配置")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name  fe.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root       /usr/share/nginx/html/dist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vue 打包后的文件夹")]),s._v("\n    index      index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    try_files  "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v("/ /index.html @rewrites"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    expires -1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 首页一般没有强制缓存")]),s._v("\n    add_header Cache-Control no-cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 接口转发，如果需要的话")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#location ~ ^/api {")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  proxy_pass http://be.sherlocked93.club;")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#}")]),s._v("\n  \n  location @rewrites "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    rewrite ^"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ /index.html "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"_13-6-http-请求转发到-https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-6-http-请求转发到-https"}},[s._v("#")]),s._v(" 13.6 HTTP 请求转发到 HTTPS")]),s._v(" "),a("p",[s._v("配置完 HTTPS 后，浏览器还是可以访问 HTTP 的地址 "),a("code",[s._v("http://sherlocked93.club/")]),s._v(" 的，可以做一个 301 跳转，把对应域名的 HTTP 请求重定向到 HTTPS 上")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name www.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单域名重定向")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'www.sherlocked93.club'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" https://www.sherlocked93.club"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全局非 https 协议时重定向")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scheme")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server_name")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者全部重定向")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server_name")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以上配置选择自己需要的即可，不用全部加")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"_13-7-泛域名路径分离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-7-泛域名路径分离"}},[s._v("#")]),s._v(" 13.7 泛域名路径分离")]),s._v(" "),a("p",[s._v("这是一个非常实用的技能，经常有时候我们可能需要配置一些二级或者三级域名，希望通过 Nginx 自动指向对应目录，比如：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("test1.doc.sherlocked93.club")]),s._v(" 自动指向 "),a("code",[s._v("/usr/share/nginx/html/doc/test1")]),s._v(" 服务器地址；")]),s._v(" "),a("li",[a("code",[s._v("test2.doc.sherlocked93.club")]),s._v(" 自动指向 "),a("code",[s._v("/usr/share/nginx/html/doc/test2")]),s._v(" 服务器地址；")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name  ~^"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("w-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("+"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".doc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".sherlocked93"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".club$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    root /usr/share/nginx/html/doc/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"_13-8-泛域名转发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_13-8-泛域名转发"}},[s._v("#")]),s._v(" 13.8 泛域名转发")]),s._v(" "),a("p",[s._v("和之前的功能类似，有时候我们希望把二级或者三级域名链接重写到我们希望的路径，让后端就可以根据路由解析不同的规则：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("test1.serv.sherlocked93.club/api?name=a")]),s._v(" 自动转发到 "),a("code",[s._v("127.0.0.1:8080/test1/api?name=a")]),s._v("；")]),s._v(" "),a("li",[a("code",[s._v("test2.serv.sherlocked93.club/api?name=a")]),s._v(" 自动转发到 "),a("code",[s._v("127.0.0.1:8080/test2/api?name=a")]),s._v(" ；")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name ~^"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("w-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("+"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".serv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".sherlocked93"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".club$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_set_header        X-Real-IP "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_set_header        X-Forwarded-For "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$proxy_add_x_forwarded_for")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_set_header        Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_set_header        X-NginX-Proxy "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_pass              http://127.0.0.1:8080/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"_14-最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-最佳实践"}},[s._v("#")]),s._v(" 14. 最佳实践")]),s._v(" "),a("ol",[a("li",[s._v("为了使 Nginx 配置更易于维护，建议为每个服务创建一个单独的配置文件，存储在 "),a("code",[s._v("/etc/nginx/conf.d")]),s._v(" 目录，根据需求可以创建任意多个独立的配置文件。")]),s._v(" "),a("li",[s._v("独立的配置文件，建议遵循以下命名约定 "),a("code",[s._v("<服务>.conf")]),s._v("，比如域名是 "),a("code",[s._v("sherlocked93.club")]),s._v("，那么你的配置文件的应该是这样的 "),a("code",[s._v("/etc/nginx/conf.d/sherlocked93.club.conf")]),s._v("，如果部署多个服务，也可以在文件名中加上 Nginx 转发的端口号，比如 "),a("code",[s._v("sherlocked93.club.8080.conf")]),s._v("，如果是二级域名，建议也都加上 "),a("code",[s._v("fe.sherlocked93.club.conf")]),s._v("。")]),s._v(" "),a("li",[s._v("常用的、复用频率比较高的配置可以放到 "),a("code",[s._v("/etc/nginx/snippets")]),s._v(" 文件夹，在 Nginx 的配置文件中需要用到的位置 include 进去，以功能来命名，并在每个 snippet 配置文件的开头注释标明主要功能和引入位置，方便管理。比如之前的 "),a("code",[s._v("gzip")]),s._v("、"),a("code",[s._v("cors")]),s._v(" 等常用配置，我都设置了 snippet。")]),s._v(" "),a("li",[s._v("Nginx 日志相关目录，内以 "),a("code",[s._v("域名.type.log")]),s._v(" 命名（比如 "),a("code",[s._v("be.sherlocked93.club.access.log")]),s._v(" 和 "),a("code",[s._v("be.sherlocked93.club.error.log")]),s._v(" ）位于 "),a("code",[s._v("/var/log/nginx/")]),s._v(" 目录中，为每个独立的服务配置不同的访问权限和错误日志文件，这样查找错误时，会更加方便快捷。")])]),s._v(" "),a("p",[s._v("参考文章："),a("a",{attrs:{href:"https://mp.weixin.qq.com/s?src=11&timestamp=1611030606&ver=2837&signature=ZglV4qjTuiSTBKNLB1yp60dzHmTAekpt7sVVvhmll77HHRRIbF2VJkzQP2siEdtCuLDRS4DR1Ctiq-0Aa4Atf3Bfx-MWbLsV4pD0T2Os5AbYR7uvD*B3y19z0wrvcKNf&new=1",target:"_blank",rel:"noopener noreferrer"}},[s._v("Nginx 从入门到实践，万字详解！"),a("OutboundLink")],1)]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"一、常用配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、常用配置"}},[s._v("#")]),s._v(" 一、常用配置")]),s._v(" "),a("h3",{attrs:{id:"_1-反向代理配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-反向代理配置"}},[s._v("#")]),s._v(" 1） 反向代理配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    listen      443 ssl;\n    server_name  blog.sleepyocean.cn;\n\n    ssl on;\n    ssl_certificate /ocean/ca/blog.sleepyocean.cn/Nginx/1_blog.sleepyocean.cn_bundle.crt;\n    ssl_certificate_key /ocean/ca/blog.sleepyocean.cn/Nginx/2_blog.sleepyocean.cn.key;\n    ssl_session_timeout 10m;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n    ssl_prefer_server_ciphers on;\n\n    location / {\n        proxy_pass http://localhost:8090;\n    }\n}\n\n\nserver {\n    listen      80;\n    server_name  blog.sleepyocean.cn;\n\n    location / {\n        proxy_pass http://localhost:8090;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);